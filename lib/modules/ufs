--Uber File System Driver. Works with fsd.

ufs = {}

local oldfs = deepcopy(fs)

ufs.list = function(mountPath, path)
  path = fs.normalizePath(path)
  if not fs.isDir(path) then
    error("Not a directory")
  end
  if not fs.testPerms(path, thread.getUID(coroutine.running()), "x") then
    error("Access denied!")
    return {}
  end
  if path == "/" then path = "" end
  local p = oldfs.list(path)
  for i = 1, #p do
    if path .. "/" .. p[i] == "/rom" then
      table.remove(p, i)
    end
  end
  return p
end

ufs.exists = function(mountPath, path)
  path = fs.normalizePath(path)
  if string.sub(path, 1, 4) == "/rom" then
    return false
  end
  return oldfs.exists(path)
end

ufs.isDir = function(mountPath, path)
  path = fs.normalizePath(path)
  if string.sub(path, 1, 4) == "/rom" then
    return false
  end
  return oldfs.isDir(path)
end

ufs.open = function(mountPath, path, mode)
  local tmode = "w"
  if string.sub(mode, 1, 1) == "r" then
    tmode = "r"
  end
  if not fs.testPerms(path, thread.getUID(coroutine.running()), tmode) then
    error("Access denied!")
    return
  end
  return oldfs.open(path, mode)
end

ufs.makeDir = function(mountPath, path)
  local parent = fs.normalizePath(fs.getDir(path))
  if not fs.testPerms(parent, thread.getUID(coroutine.running()), "w") then
    error("Access denied!")
    return
  end
  oldfs.makeDir(path)
end

ufs.move = function(mountPath, from, to)
  if not fs.testPerms(fs.getDir(to), thread.getUID(coroutine.running()), "w") or
     not fs.testPerms(fs.getDir(from), thread.getUID(coroutine.running()), "w") then
     error("Access denied!")
     return
  end
  oldfs.move(from, to)
end

ufs.copy = function(mountPath, from, to)
  if not fs.testPerms(to, thread.getUID(coroutine.running()), "r") or
     not fs.testPerms(fs.getDir(from), thread.getUID(coroutine.running()), "w") then
     error("Access denied!")
     return
  end
  oldfs.copy(from, to)
end


ufs.delete = function(mountPath, path)
  local parent = fs.normalizePath(fs.getDir(path))
  if not fs.testPerms(parent, thread.getUID(coroutine.running()), "w") then
    error("Access denied!")
    return
  end
  oldfs.delete(path)
end

ufs = applyreadonly(ufs)
